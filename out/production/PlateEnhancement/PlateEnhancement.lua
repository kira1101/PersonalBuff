---
--- Generated by EmmyLua(https://github.com/EmmyLua)
--- Created by kira1101.
--- DateTime: 2020/9/10 下午 12:46
---

local TriggerOn = false

local function setAuraTime(time,parent)
    if time and time~=0 then
        local f = CreateFrame("Frame", nil, parent)
        f:SetWidth(1)
        f:SetHeight(1)
        f:SetPoint("CENTER", 0, 0)
        local t = f:CreateFontString(f, "OVERLAY")
        t:SetFont("Fonts\\bKAI00M.TTF", 11, "MONOCHROME")
        t:SetPoint("CENTER", 0, 0)
        local AuraTime = time - GetTime()
        if(AuraTime > 60) then
            t:SetText(math.floor(AuraTime / 60) .. "m")
        else
            t:SetText(math.floor(AuraTime))
        end
    end
end

local function iconEnable(spellID)
    for _,i in pairs(aceDB.profile.spells) do
        if i.spellID == spellID then
            return true
        end
    end
    return false
end

local function setAuraIcon(spellID,time,parent,order,duration)

    if iconEnable(spellID) then
        local aura = CreateFrame("Frame",nil,parent)
        aura:SetSize(20,20)
        aura:SetPoint("LEFT", order*20 + order,0)

        local texture = aura:CreateTexture(nil,"ARTWORK")
        texture:SetTexture(GetSpellTexture(spellID))
        texture:SetPoint("CENTER")
        texture:SetSize(20,20)
        local cooldown = CreateFrame("Cooldown", nil, aura, "CooldownFrameTemplate")
        cooldown:SetAllPoints()
        cooldown:SetCooldown(time - duration,duration)

        return true
    else
        return false
    end
    --setAuraTime(time,aura)
end

function updateAura(parent)
    if iconsFrame then
        iconsFrame:Hide()
    end
    iconsFrame = CreateFrame("Frame","SpellIcons",parent)
    iconsFrame:SetWidth(300)
    iconsFrame:SetHeight(20)
    iconsFrame:SetPoint("LEFT",parent,"TOPLEFT")
    local iconCount = 1
    for i=1,40 do
        local aura = {UnitAura("player",i)}
        if aura then
            local result = setAuraIcon(aura[10],aura[6],iconsFrame,iconCount,aura[5])
            if result == true then
                iconCount = iconCount + 1
            end
        else
            return
        end
    end
end

local function InitializeDB()
    print("InitializeDB")
    local defaultSettings = {
        profile = {
            hideBlizzardAuras = true,
            iconSize = 20,
            spells = {
                {
                  spellID = 193530,
                  enable = true,
                  spellName = "",
                },
            }
        }
    }
    aceDB = LibStub("AceDB-3.0"):New("PlateEnhancementAceDB", defaultSettings)
end

local function EventHandler(self, event, msg, sender)
    if event == "PLAYER_ENTERING_WORLD" then
        InitializeDB()
    else
        namePlateUpdate()
    end

end

local function registerAuraEvent()
    eventFrame = CreateFrame("Frame")
    eventFrame:RegisterEvent("UNIT_AURA")
    eventFrame:RegisterEvent("NAME_PLATE_UNIT_ADDED")
    eventFrame:RegisterEvent("NAME_PLATE_UNIT_REMOVED")
    eventFrame:RegisterEvent("PLAYER_ENTERING_WORLD")
    eventFrame:SetScript("OnEvent", EventHandler)
end

local function OnUpdate()
    local namePlatePlayer = C_NamePlate.GetNamePlateForUnit("player", issecure())
    if namePlatePlayer then
        --namePlatePlayer.UnitFrame.BuffFrame:SetAlpha(0)
        updateAura(namePlatePlayer)
    else
        if iconsFrame ~= nil then
            iconsFrame:Hide()
            iconsFrame = nil
            myTicker:Cancel()
            TriggerOn = false
        end
    end
end

function namePlateUpdate()
    if (TriggerOn == false) then
        TriggerOn = true
        myTicker = C_Timer.NewTicker(0.1, OnUpdate)
    end
end

registerAuraEvent()